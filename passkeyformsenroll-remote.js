function PasskeyRegistrationField(e,t,o,n){let s,a,l;const i=!1,d=!0;function c(e){const t=new Uint8Array(e);let o="";for(let n=0;n<t.byteLength;n++)o+=String.fromCharCode(t[n]);return btoa(o).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function u(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const o=t.length%4;if(o)t+=new Array(5-o).join("=");const n=atob(t),s=new ArrayBuffer(n.length);let a=new Uint8Array(s);for(let i=0;i<n.length;i++)a[i]=n.charCodeAt(i);return s}function p(e,t=!1){if(a){a.innerHTML="";const o=document.createElement("span");o.className="message-icon",o.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg>`,t||(o.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" /></svg>`);const r=document.createTextNode(e);a.appendChild(o),a.appendChild(r),a.style.display="flex",a.classList.remove("info","error"),a.classList.add(t?"error":"info")}}let h=!1;async function m(){p("Starting passkey registration process...",!1),s&&(s.disabled=!0);try{const r=await fetch(`https://${t}/me/v1/authentication-methods`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({type:"passkey"})});if(!r.ok){const t=await r.json();throw new Error(`Failed to retrieve challenge: ${t.error_description||JSON.stringify(t)}`)}const c=await r.json(),{authn_params_public_key:m,auth_session:f}=c,y={challenge:u(m.challenge),rp:m.rp,user:{id:u(m.user.id),name:m.user.name,displayName:m.user.displayName},pubKeyCredParams:m.pubKeyCredParams,timeout:m.timeout,attestation:m.attestation,authenticatorSelection:{requireResidentKey:!0,userVerification:"preferred"},...d||{excludeCredentials:m.excludeCredentials?m.excludeCredentials.map(e=>({id:u(e.id),type:e.type,transports:e.transports})):[]},extensions:m.extensions};p("Requesting passkey creation on your device...",!1);const v=await navigator.credentials.create({publicKey:y}),_={id:c(v.rawId),rawId:c(v.rawId),type:v.type,authenticatorAttachment:v.authenticatorAttachment,response:{clientDataJSON:c(v.response.clientDataJSON),attestationObject:c(v.response.attestationObject)}};console.log(_);const j=await fetch(`https://${t}/me/v1/authentication-methods/passkey|new/verify`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({auth_session:f,authn_response:_})});if(!j.ok){const e=await j.json();throw new Error(`Passkey verification failed: ${e.error_description||JSON.stringify(e)}`)}const g=await j.json();if(console.log("Passkey registration completed successfully:",g),g.id_token)try{const t=g.id_token,o=t.split(".")[1],n=atob(o.replace(/-/g,"+").replace(/_/g,"/")),s=JSON.parse(n);s.sub&&e.form.setHiddenField("enrolled_user_id",s.sub)}catch(x){console.error("Failed to decode ID token:",x)}p("Passkey registered successfully!",!1),h=!0,s&&(s.style.display="none"),d?(p("Success! Proceeding automatically...",!1),setTimeout(()=>{e&&e.form&&"function"==typeof e.form.goForward&&e.form.goForward()},1e3)):l&&l.classList.add("visible")}catch(w){console.error("An error occurred during passkey registration:",w),"NotAllowedError"===w.name?p("Passkey registration was cancelled. Click the button to try again.",!1):p(`Passkey registration failed: ${w.message}`,!0),h=!1}finally{s&&!h&&(s.disabled=!1)}}return{init(){if(!t||!o)return console.error("Custom Field Error: Required parameters are missing."),document.createElement("div").textContent="Custom Field Error: Required parameters are missing.",document.createElement("div");const n=document.createElement("div");n.className="passkey-container",s=document.createElement("button"),s.type="button",s.className="af-button af-nextButton",s.addEventListener("click",m);const i=document.createElement("span");i.className="af-button-text",i.style.fontWeight="bold",i.style.textAlign="center",i.style.width="100%",i.textContent="Create a Passkey",s.appendChild(i),a=document.createElement("div"),a.className="passkey-message",l=document.createElement("div"),l.className="continue-button-wrapper";const d=document.createElement("button");d.type="button",d.className="af-button af-nextButton";const c=document.createElement("span");c.className="af-button-text",c.textContent="Continue",d.appendChild(c),d.addEventListener("click",()=>{e&&e.form&&"function"==typeof e.form.goForward?e.form.goForward():console.error("form.goForward() is not available in this context.")}),l.appendChild(d),n.appendChild(s),n.appendChild(a),n.appendChild(l);return n},block(){s&&(s.disabled=!0)},unblock(){s&&!h&&(s.disabled=!1)}}};
